# Manzana-Client
API-клиент для работы с сервисом лояльности [Manzana-Loyalty](]http://manzanagroup.ru/products/manzana-loyalty/). Главная цель гема — упростить программисту работу с сервисом, подготавливать данные, строить SOAP-запросы, отправлять их в Манзану, обрабатывать и возвращать ответ сервиса.

<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->


- [Принципы работы](#%D0%BF%D1%80%D0%B8%D0%BD%D1%86%D0%B8%D0%BF%D1%8B-%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D1%8B)
- [Параметры инициализации AccountService и LoyaltyService](#%D0%BF%D0%B0%D1%80%D0%B0%D0%BC%D0%B5%D1%82%D1%80%D1%8B-%D0%B8%D0%BD%D0%B8%D1%86%D0%B8%D0%B0%D0%BB%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D0%B8-accountservice-%D0%B8-loyaltyservice)
- [Структуры данных](#%D1%81%D1%82%D1%80%D1%83%D0%BA%D1%82%D1%83%D1%80%D1%8B-%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85)
- [Операции](#%D0%BE%D0%BF%D0%B5%D1%80%D0%B0%D1%86%D0%B8%D0%B8)
  - [Сервер личного кабинета (AccountService)](#%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80-%D0%BB%D0%B8%D1%87%D0%BD%D0%BE%D0%B3%D0%BE-%D0%BA%D0%B0%D0%B1%D0%B8%D0%BD%D0%B5%D1%82%D0%B0-accountservice)
    - [Регистрация контакта `contact_registration`](#%D1%80%D0%B5%D0%B3%D0%B8%D1%81%D1%82%D1%80%D0%B0%D1%86%D0%B8%D1%8F-%D0%BA%D0%BE%D0%BD%D1%82%D0%B0%D0%BA%D1%82%D0%B0-contact_registration)
    - [Завершение регистрации `complete_registration`](#%D0%B7%D0%B0%D0%B2%D0%B5%D1%80%D1%88%D0%B5%D0%BD%D0%B8%D0%B5-%D1%80%D0%B5%D0%B3%D0%B8%D1%81%D1%82%D1%80%D0%B0%D1%86%D0%B8%D0%B8-complete_registration)
    - [Повторная отправка СМС-кода `registration_code_send`](#%D0%BF%D0%BE%D0%B2%D1%82%D0%BE%D1%80%D0%BD%D0%B0%D1%8F-%D0%BE%D1%82%D0%BF%D1%80%D0%B0%D0%B2%D0%BA%D0%B0-%D1%81%D0%BC%D1%81-%D0%BA%D0%BE%D0%B4%D0%B0-registration_code_send)
    - [Отмена регистрации `rollback_registration`](#%D0%BE%D1%82%D0%BC%D0%B5%D0%BD%D0%B0-%D1%80%D0%B5%D0%B3%D0%B8%D1%81%D1%82%D1%80%D0%B0%D1%86%D0%B8%D0%B8-rollback_registration)
    - [Замена карты `card_replace`](#%D0%B7%D0%B0%D0%BC%D0%B5%D0%BD%D0%B0-%D0%BA%D0%B0%D1%80%D1%82%D1%8B-card_replace)
  - [Сервер лояльности (LoyaltyService)](#%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80-%D0%BB%D0%BE%D1%8F%D0%BB%D1%8C%D0%BD%D0%BE%D1%81%D1%82%D0%B8-loyaltyservice)
    - [Запрос баланса `balance_request`](#%D0%B7%D0%B0%D0%BF%D1%80%D0%BE%D1%81-%D0%B1%D0%B0%D0%BB%D0%B0%D0%BD%D1%81%D0%B0-balance_request)
    - [Запрос чека `cheque_request`](#%D0%B7%D0%B0%D0%BF%D1%80%D0%BE%D1%81-%D1%87%D0%B5%D0%BA%D0%B0-cheque_request)
  - [Операции высокого уровня (LoyaltyService::Operations)](#%D0%BE%D0%BF%D0%B5%D1%80%D0%B0%D1%86%D0%B8%D0%B8-%D0%B2%D1%8B%D1%81%D0%BE%D0%BA%D0%BE%D0%B3%D0%BE-%D1%83%D1%80%D0%BE%D0%B2%D0%BD%D1%8F-loyaltyserviceoperations)
    - [Продажа `sale`](#%D0%BF%D1%80%D0%BE%D0%B4%D0%B0%D0%B6%D0%B0-sale)
    - [Возврат продажи `return`](#%D0%B2%D0%BE%D0%B7%D0%B2%D1%80%D0%B0%D1%82-%D0%BF%D1%80%D0%BE%D0%B4%D0%B0%D0%B6%D0%B8-return)
    - [Откат продажи `rollback`](#%D0%BE%D1%82%D0%BA%D0%B0%D1%82-%D0%BF%D1%80%D0%BE%D0%B4%D0%B0%D0%B6%D0%B8-rollback)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

## Принципы работы
Работа происходит не с одним сервером, а с двумя:

1. Сервер личного кабинета — отвечает за следующие операции:
   - регистрация контакта (участника программы лояльности);
   - подтверждение СМС-кода (завершение регистрации);
   - отправка повторного СМС-кода;
   - откат регистрации.
2. Сервер лояльности — отвечает за следующие операции:
   - запрос баланса;
   - отправка мягкого (предварительного) чека;
   - отправка фискального чека;
   - возврат продажи;
   - откат продажи.

Соответственно, реализованы 2 модуля:

1. `AccountService` — отвечает за взаимодействие с сервером личного кабинета;
2. `LoyaltyService` — отвечает за взаимодействие с сервером лояльности.

## Параметры инициализации AccountService и LoyaltyService

- `wsdl` — адрес WSDL-сервера Манзаны. Предоставляет Манзана
- `basic_auth` — базовая аутентификация (не обязательный). Варианты: `false` или `['логин', 'пароль']`
- `organization` — идентификатор организации в БД Манзаны. Предоставляет Манзана
- `business_unit` — идентификатор аптеки в БД Манзаны. Предоставляет Манзана
- `pos` — номер ККМ. Устанавливается клиентом
- `org_name` — название организации в БД Манзаны. Предоставляет Манзана
- `logger` — логгер (не обязательный). Варианты: `false` или инстанс `Logger`
- `timeout` — таймаут для запросов, секунды (не обязательный)


## Структуры данных
Запросы, отправляемые в Манзану, имеют сложную структуру и много параметров. Поэтому, для упрощения работы с параметрами, были созданы 6 кастомных структур данных:

1. `Data::Cheque` — тело запроса чека, основные параметры чека
2. `Data::ChequeItem` — параметры позиции чека. Заполяются для каждой позиции чека и массивом передаются в параметре `items` у `Data::Cheque`
3. `Data::RollbackCheque` – параметры для запроса на откат фискального чека
4. `Data::SaleCheque` — аналог `Data::Cheque` для операций высокого уровня (подробнее ниже). Принимает только самые необходимые параметры чека, остальные высчитывает самостоятельно.
5. `Data::SaleChequeItem` — аналог `Data::ChequeItem` для операций высокого уровня

Эти структуры данных используются только в запросах к серверу лояльности.


## Операции

### Сервер личного кабинета (AccountService)

#### Регистрация контакта `contact_registration`
Принимает мобильный телефон, номер карты и номер анкеты. Возвращает идентификатор контакта.

В Манзане создается новый участник и привязывается к анкете. Для активации учетной записи требуется подтверждение номера телефона через СМС-код.

При обработке этого запроса на телефон участника отправляется СМС-код.

#### Завершение регистрации `complete_registration`
Принимает идентификатор контакта, полученный из `contact_registration`, и СМС-код, который был отправлен на мобильный телефон участника. Возвращает true в случае успеха или ошибку.

#### Повторная отправка СМС-кода `registration_code_send`
Принимает идентификатор контакта, полученный из `contact_registration`. Возвращаяет true в случае успеха или ошибку.

#### Отмена регистрации `rollback_registration`
Принимает идентификатор контакта, полученный из `contact_registration`. Возвращаяет true в случае успеха или ошибку.

Отменяет как начатую регистрацию (после ввода анкеты), так и завершенную (после подтверждения СМС-кода).

#### Замена карты `card_replace`
Принимает номер **новой карты** и номер мобильного телефона. Возвращает true в случае успеха или ошибку.

### Сервер лояльности (LoyaltyService)

#### Запрос баланса `balance_request`
Принимает номер карты или мобильный телефон. Возвращает результат в виде хэша.

#### Запрос чека `cheque_request`
Принимает тип чека (`Soft` или `Fiscal`) и `Data::Cheque`. Возвращает результат в виде хэша.

Через этот запрос совершаются все основные операции по работае с продажами: сама продажа, откат продажи в случае сбоя, возврат продажи. Тип операции указывается в параметре `operation_type` структуры `Data::Cheque`. Есть следующие типы:

1. Sale — продажа;
2. Rollback – откат в случае сбоя;
3. Return — возврат.

Для всех операций, кроме продажи, тип чека должен быть `Soft`. Для совершения продажи необходимо сначала отправить чек с типом `Soft` (мягкий чек), а затем точно такой же чек, но с типом `Fiscal` (фискальный чек). Регистрация продажи в Манзане происходит именно при отправке фискального чека. Мягкий чек является предварительным и служит для проверки параметров чека и получения информации о чеке (количество баллов в чеке).

### Операции высокого уровня (LoyaltyService::Operations)
Чтобы упростить работу с сервисом, были разработаны операции высокого уровня. Они представляют собой всего-лишь обертки над операцией запроса чека `cheque_request`, принимающие только самые необходимые параметры и высчитывающие остальные параметры самостоятельно.

#### Продажа `sale`
Принимает `Data::SaleCheque` и возвращает результат в виде хэша.

Регистрация продажи. Под капотом — последовательность из запроса мягкого и фискального чеков.

#### Возврат продажи `return`
Принимает `Data::SaleCheque` и `uuid` возвращаемого чека. Возвращает результат в виде хэша.

Подготавливает данные и отправляет мягкий чек с `operation_type` равным `Return`.

#### Откат продажи `rollback`
Принимает номер карты, по которой была совершена продажа, и идентификатор транзакции, полученный в ответ на фискальный запрос.

Подготавливает данные и отправляет мягкий чек с `operation_type` равным `Rollback`.
