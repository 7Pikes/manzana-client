# Manzana-Client
API-клиент для работы с сервисом лояльности [Manzana-Loyalty](]http://manzanagroup.ru/products/manzana-loyalty/). Главная цель гема — упростить программисту работу с сервисом, подготавливать данные, строить SOAP-запросы, отправлять их в Манзану, обрабатывать и возвращать ответ сервиса.

## Принципы работы
Работа происходит не с одним сервером, а с двумя:

1. Сервер личного кабинета — отвечает за следующие операции:
   - регистрация контакта (участника программы лояльности);
   - подтверждение СМС-кода (завершение регистрации);
   - отправка повторного СМС-кода;
   - откат регистрации.
2. Сервер лояльности — отвечает за следующие операции:
   - запрос баланса;
   - отправка мягкого (предварительного) чека;
   - отправка фискального чека;
   - возврат продажи;
   - откат продажи.

Соответственно, реализованы 2 модуля:

1. `AccountService` — отвечает за взаимодействие с сервером личного кабинета;
2. `LoyaltyService` — отвечает за взаимодействие с сервером лояльности.

## Параметры инициализации AccountService и LoyaltyService

- `wsdl` — адрес WSDL-сервера Манзаны. Предоставляет Манзана
- `basic_auth` — базовая аутентификация (не обязательный). Варианты: `false` или `['логин', 'пароль']`
- `organization` — идентификатор организации в БД Манзаны. Предоставляет Манзана
- `business_unit` — идентификатор аптеки в БД Манзаны. Предоставляет Манзана
- `pos` — номер ККМ. Устанавливается клиентом
- `org_name` — название организации в БД Манзаны. Предоставляет Манзана
- `logger` — логгер (не обязательный). Варианты: `false` или инстанс `Logger`
- `timeout` — таймаут для запросов, секунды (не обязательный)


## Структуры данных
Запросы, отправляемые в Манзану, имеют сложную структуру и много параметров. Поэтому, для упрощения работы с параметрами, были созданы 6 кастомных структур данных:

1. `Data::Cheque` — тело запроса чека, основные параметры чека
2. `Data::ChequeItem` — параметры позиции чека. Заполяются для каждой позиции чека и массивом передаются в параметре `items` у `Data::Cheque`
3. `Data::RollbackCheque` – параметры для запроса на откат фискального чека
4. `Data::SaleCheque` — аналог `Data::Cheque` для операций высокого уровня (подробнее ниже). Принимает только самые необходимые параметры чека, остальные высчитывает самостоятельно.
5. `Data::SaleChequeItem` — аналог `Data::ChequeItem` для операций высокого уровня

Эти структуры данных используются только в запросах к серверу лояльности.


## Операции

### Сервер личного кабинета (AccountService)

#### Регистрация контакта `contact_registration`
Принимает мобильный телефон, номер карты и номер анкеты. Возвращает идентификатор контакта.

В Манзане создается новый участник и привязывается к анкете. Для активации учетной записи требуется подтверждение номера телефона через СМС-код.

При обработке этого запроса на телефон участника отправляется СМС-код.

#### Завершение регистрации `complete_registration`
Принимает идентификатор контакта, полученный из `contact_registration`, и СМС-код, который был отправлен на мобильный телефон участника. Возвращает true в случае успеха или ошибку.

#### Повторная отправка СМС-кода `registration_code_send`
Принимает идентификатор контакта, полученный из `contact_registration`. Возвращаяет true в случае успеха или ошибку.

#### Отмена регистрации `rollback_registration`
Принимает идентификатор контакта, полученный из `contact_registration`. Возвращаяет true в случае успеха или ошибку.

Отменяет как начатую регистрацию (после ввода анкеты), так и завершенную (после подтверждения СМС-кода).

#### Замена карты `card_replace`
Принимает номер **новой карты** и номер мобильного телефона. Возвращает true в случае успеха или ошибку.

### Сервер лояльности (LoyaltyService)

#### Запрос баланса `balance_request`
Принимает номер карты или мобильный телефон. Возвращает результат в виде хэша.

#### Запрос чека `cheque_request`
Принимает тип чека (`Soft` или `Fiscal`) и `Data::Cheque`. Возвращает результат в виде хэша.

Через этот запрос совершаются все основные операции по работае с продажами: сама продажа, откат продажи в случае сбоя, возврат продажи. Тип операции указывается в параметре `operation_type` структуры `Data::Cheque`. Есть следующие типы:

1. Sale — продажа;
2. Rollback – откат в случае сбоя;
3. Return — возврат.

Для всех операций, кроме продажи, тип чека должен быть `Soft`. Для совершения продажи необходимо сначала отправить чек с типом `Soft` (мягкий чек), а затем точно такой же чек, но с типом `Fiscal` (фискальный чек). Регистрация продажи в Манзане происходит именно при отправке фискального чека. Мягкий чек является предварительным и служит для проверки параметров чека и получения информации о чеке (количество баллов в чеке).

### Операции высокого уровня (LoyaltyService::Operations)
Чтобы упростить работу с сервисом, были разработаны операции высокого уровня. Они представляют собой всего-лишь обертки над операцией запроса чека `cheque_request`, принимающие только самые необходимые параметры и высчитывающие остальные параметры самостоятельно.

#### Продажа `sale`
Принимает `Data::SaleCheque` и возвращает результат в виде хэша.

Регистрация продажи. Под капотом — последовательность из запроса мягкого и фискального чеков.

#### Возврат продажи `return`
Принимает `Data::SaleCheque` и `uuid` возвращаемого чека. Возвращает результат в виде хэша.

Подготавливает данные и отправляет мягкий чек с `operation_type` равным `Return`.

#### Откат продажи `rollback`
Принимает номер карты, по которой была совершена продажа, и идентификатор транзакции, полученный в ответ на фискальный запрос.

Подготавливает данные и отправляет мягкий чек с `operation_type` равным `Rollback`.
